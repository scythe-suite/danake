echo1 "Utils (context: $DANAKE_CONTEXT)"

subcommand="$1"
shift || true
if [ -z "$subcommand" ]; then
  echo "danake: utils: known subcommands: monitor, cookies, tokens, ufw" >&2
  exit
fi

case "$subcommand" in

    monitor)
      url="https://$DANAKE_MANAGER_HOST:9000/"
      echo2 "Opening monitor at $url"
      python -m webbrowser -n "$url"
    ;;

    tokens)
      echo2 "Extracting tokens"
      eval $(grep SECRET_KEY "$DANAKE_CONFS/auth-config.py" | tr -d ' ')
      curl -H "X-DANAKE-AUTH: $SECRET_KEY" https://$DANAKE_MANAGER_HOST/da/tokens
    ;;

    ufw)
      echo2 "Firewall rules"
      echo -e "Please issue the following commands\n"
      cat >/dev/stdout <<EOF
        sudo ufw allow proto tcp from ${DANAKE_NETWORK} to any port 2377
        sudo ufw allow proto tcp from ${DANAKE_NETWORK} to any port 7946
        sudo ufw allow proto udp from ${DANAKE_NETWORK} to any port 7946
        sudo ufw allow proto udp from ${DANAKE_NETWORK} to any port 4789
EOF
    ;;

    *)
        echo "danake: utils: subcommand '$subcommand' not recognized" >&2
        exit 1
esac

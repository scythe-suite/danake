echo1 "Utils (context: $DANAKE_CONTEXT)"

subcommand="$1"
shift || true
if [ -z "$subcommand" ]; then
  echo "danake: utils: known subcommands: status, exec, cli, monitor, tokens, ufw" >&2
  exit
fi

case "$subcommand" in

    status)
      echo2 "Danake status"
      echo3 "Nodes"
      docker node ls
      echo3 "Stacks"
      docker stack ls
      echo3 "Services"
      docker service ls
    ;;

    exec)
      echo2 "Determining host and container id"
      uid=$1
      shift || true
      host=$(docker service inspect editor-$uid -f '{{.Spec.Labels.danake_host}}')
      echo3 "Connecting via ssh to docker agent on $host"
      id=$(docker service ps editor-$uid --no-trunc --filter "name=editor-${uid}.1" --filter 'desired-state=running' --format '{{.ID}}')
      docker -H "ssh://$host" exec -it "editor-${uid}.1.${id}" "$@"
    ;;

    cli)
      echo2 "Running an instance of the cli on the editor network"
      docker run -it --rm --name cli --entrypoint '' \
        --network danake_editor_network --hostname cli \
        --mount type=volume,source=danake_cli,target=/home/cli/data \
        127.0.0.1:5000/cli bash
    ;;

    reaper-sign)
      export REAPER_SESSION=$1
      shift || true
      if [ -z "$REAPER_SESSION" ]; then
        echo Please specify session >&2
        exit 1
      fi
      echo2 Performing reaper sign for $REAPER_SESSION
      cat "$DANAKE_CONFS/uid2info.tsv" | \
        docker run -i --rm \
          --env REAPER_SESSION \
          --network danake_editor_network \
          $DANAKE_REGISTRY/cli:$DANAKE_VERSION reaper-sign
    ;;

    monitor)
      url="https://$DANAKE_MANAGER_HOST:9000/"
      echo2 "Opening monitor at $url"
      python -m webbrowser -n "$url"
    ;;

    tokens)
      echo2 "Extracting tokens"
      eval $(grep SECRET_KEY "$DANAKE_CONFS/auth-config.py" | tr -d ' ')
      curl -H "X-DANAKE-AUTH: $SECRET_KEY" https://$DANAKE_MANAGER_HOST/da/tokens
    ;;

    ufw)
      echo2 "Firewall rules"
      echo -e "Please issue the following commands\n"
      cat >/dev/stdout <<EOF
        sudo ufw allow proto tcp from ${DANAKE_NETWORK} to any port 2377
        sudo ufw allow proto tcp from ${DANAKE_NETWORK} to any port 7946
        sudo ufw allow proto udp from ${DANAKE_NETWORK} to any port 7946
        sudo ufw allow proto udp from ${DANAKE_NETWORK} to any port 4789
EOF
    ;;

    *)
        echo "danake: utils: subcommand '$subcommand' not recognized" >&2
        exit 1
esac
